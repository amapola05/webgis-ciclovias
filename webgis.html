<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa WebGIS – Ciclovías</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body { margin: 0; }
  #map { width: 100%; height: 100vh; }
</style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// =======================
//  CONFIG FIREBASE
// =======================
const firebaseConfig = {
  apiKey: "AIzaSyBQxsnjOfPRs7dq7YPpEScStSuQshW9YgU8",
  authDomain: "ciclovias-3d361.firebaseapp.com",
  projectId: "ciclovias-3d361",
  storageBucket: "ciclovias-3d361.appspot.com",
  messagingSenderId: "94373830982",
  appId: "1:94373830982:web:afbf251bfc78b9c7744547"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// =======================
//  MAPA
// =======================
const map = L.map("map").setView([-33.45, -70.66], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

// Colores de puntos según gravedad
const colores = {
  "Bajo": "green",
  "Medio": "orange",
  "Alto": "red"
};

// =======================
// Cargar reportes aprobados
// =======================
db.collection("reportes")
  .where("estado", "==", "aprobado")
  .onSnapshot((query) => {
    query.forEach((doc) => {
      const data = doc.data();

      // ---- Punto del problema ----
      const punto = L.circleMarker([data.latProblema, data.lngProblema], {
        radius: 8,
        color: colores[data.gravedad] || "blue",
        fillColor: colores[data.gravedad] || "blue",
        fillOpacity: 0.9
      }).addTo(map);

      const foto = data.fotoURL ? `<a href="${data.fotoURL}" target="_blank">Ver foto</a>` : "No enviada";

      punto.bindPopup(`
        <b>Problema:</b> ${data.problema}<br>
        <b>Gravedad:</b> ${data.gravedad}<br>
        <b>Comentario:</b> ${data.comentario || "Sin comentario"}<br>
        <b>Coordenadas:</b> ${data.latProblema.toFixed(4)}, ${data.lngProblema.toFixed(4)}<br>
        <b>Foto:</b> ${foto}
      `);

      // ---- Ruta en GeoJSON ----
      try {
        const rutaJSON = JSON.parse(data.rutaGeoJSON);
        L.geoJSON(rutaJSON, {
          style: { color: "#0077ff", weight: 3 }
        }).addTo(map);
      } catch (e) {
        console.warn("Ruta inválida en reporte", doc.id);
      }
    });
  });

</script>
</body>
</html>
