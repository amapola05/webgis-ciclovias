<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de reportes validados de ciclovías</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f6fa;
    }

    header {
      background: #26689c;
      color: #fff;
      padding: 0.8rem 1.2rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.25rem;
    }

    header p {
      margin: 0.1rem 0 0;
      font-size: 0.85rem;
      opacity: 0.9;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(280px, 1fr);
      gap: 1rem;
      align-items: flex-start;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      padding: 0.75rem;
    }

    #map {
      width: 100%;
      height: 520px;
      border-radius: 8px;
    }

    .legend {
      position: absolute;
      left: 16px;
      bottom: 20px;
      z-index: 1000;
      background: #fff;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      font-size: 0.8rem;
    }
    .legend h4 {
      margin: 0 0 0.25rem;
      font-size: 0.85rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin: 0.1rem 0;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* Panel filtros */
    h2 {
      margin-top: 0;
      font-size: 1rem;
    }

    label {
      display: block;
      margin: 0.4rem 0 0.15rem;
      font-size: 0.85rem;
      font-weight: 600;
    }

    select {
      width: 100%;
      padding: 0.35rem 0.4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.85rem;
      box-sizing: border-box;
    }

    .stats {
      margin-top: 0.75rem;
      font-size: 0.85rem;
    }

    .badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      font-size: 0.75rem;
      color: #fff;
      margin-left: 0.2rem;
    }
    .baja   { background:#28a745; }
    .media  { background:#ffc107; color:#000; }
    .alta   { background:#dc3545; }

    .help-text {
      font-size: 0.75rem;
      color: #555;
      margin-top: 0.6rem;
    }

    .popup-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .popup-row {
      font-size: 0.8rem;
      margin: 0.05rem 0;
    }
    .popup-row span {
      font-weight: 600;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      #map {
        height: 420px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Mapa de reportes validados de ciclovías</h1>
  <p>Se muestran solo los reportes <strong>aprobados</strong> por el administrador.</p>
</header>

<main>
  <div class="layout">
    <!-- MAPA -->
    <div class="card" style="position:relative;">
      <div id="map"></div>

      <!-- Leyenda -->
      <div class="legend">
        <h4>Leyenda</h4>
        <div class="legend-item">
          <span class="legend-dot" style="background:#28a745;"></span>
          <span>Problema gravedad baja</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot" style="background:#ffc107;"></span>
          <span>Problema gravedad media</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot" style="background:#dc3545;"></span>
          <span>Problema gravedad alta</span>
        </div>
        <div class="legend-item">
          <span style="width:18px;height:2px;background:#007bff;"></span>
          <span>Ruta declarada por la persona</span>
        </div>
      </div>
    </div>

    <!-- PANEL FILTROS -->
    <div class="card">
      <h2>Filtros y resumen</h2>

      <label for="selectRegion">Región</label>
      <select id="selectRegion">
        <option value="TODAS">Todas las regiones</option>
      </select>

      <label for="selectCiudad">Ciudad / comuna</label>
      <select id="selectCiudad">
        <option value="TODAS">Todas las ciudades</option>
      </select>

      <div class="stats">
        <div>Reportes mostrados: <span id="statTotal">0</span></div>
        <div>
          Gravedad baja:
          <span id="statBaja">0</span>
          <span class="badge baja">Baja</span>
        </div>
        <div>
          Gravedad media:
          <span id="statMedia">0</span>
          <span class="badge media">Media</span>
        </div>
        <div>
          Gravedad alta:
          <span id="statAlta">0</span>
          <span class="badge alta">Alta</span>
        </div>
      </div>

      <p class="help-text">
        Los filtros aplican solo a los reportes validados. Puedes usarlos
        para revisar situaciones particulares en una región o ciudad específica.
      </p>
    </div>
  </div>
</main>

<script>
  // =========================
  //  CONFIGURACIÓN FIREBASE
  //  (mismo proyecto ciclovias)
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyBQxsnjOfPRs7dq7YPpEScStSuQshW9YgU8",
    authDomain: "ciclovias-3d361.firebaseapp.com",
    projectId: "ciclovias-3d361",
    storageBucket: "ciclovias-3d361.appspot.com",
    messagingSenderId: "94373830982",
    appId: "1:94373830982:web:afbf251bfc78b9c7744547"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // =========================
  //  MAPA
  // =========================
  const map = L.map("map").setView([-35, -70], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  const capaReportes = L.layerGroup().addTo(map);

  // =========================
  //  ESTADO
  // =========================
  let todosReportes = []; // todos los aprobados
  const selectRegion = document.getElementById("selectRegion");
  const selectCiudad = document.getElementById("selectCiudad");

  const statTotal = document.getElementById("statTotal");
  const statBaja  = document.getElementById("statBaja");
  const statMedia = document.getElementById("statMedia");
  const statAlta  = document.getElementById("statAlta");

  // =========================
  //  FUNCIONES AUXILIARES
  // =========================

  function obtenerColorGravedad(g) {
    if (!g) return "#888";
    const val = g.toLowerCase();
    if (val.startsWith("bajo"))  return "#28a745";
    if (val.startsWith("medio")) return "#ffc107";
    if (val.startsWith("alto"))  return "#dc3545";
    return "#888";
  }

  function poblarFiltros() {
    const regiones = new Set();
    const ciudadesPorRegion = {};

    todosReportes.forEach(r => {
      const reg = r.region || "Sin región";
      const ciu = r.ciudad || "Sin ciudad";

      regiones.add(reg);
      if (!ciudadesPorRegion[reg]) {
        ciudadesPorRegion[reg] = new Set();
      }
      ciudadesPorRegion[reg].add(ciu);
    });

    // Región
    selectRegion.innerHTML = '<option value="TODAS">Todas las regiones</option>';
    Array.from(regiones).sort().forEach(reg => {
      const opt = document.createElement("option");
      opt.value = reg;
      opt.textContent = reg;
      selectRegion.appendChild(opt);
    });

    // Ciudad (todas al inicio)
    actualizarCiudades();
  }

  function actualizarCiudades() {
    const regionSel = selectRegion.value;
    selectCiudad.innerHTML =
      '<option value="TODAS">Todas las ciudades</option>';

    let ciudadesSet = new Set();

    todosReportes.forEach(r => {
      if (regionSel !== "TODAS" && r.region !== regionSel) return;
      const ciu = r.ciudad || "Sin ciudad";
      ciudadesSet.add(ciu);
    });

    Array.from(ciudadesSet).sort().forEach(ciu => {
      const opt = document.createElement("option");
      opt.value = ciu;
      opt.textContent = ciu;
      selectCiudad.appendChild(opt);
    });
  }

  function aplicarFiltros() {
    const regionSel = selectRegion.value;
    const ciudadSel = selectCiudad.value;

    let filtrados = todosReportes.slice();

    if (regionSel !== "TODAS") {
      filtrados = filtrados.filter(r => r.region === regionSel);
    }
    if (ciudadSel !== "TODAS") {
      filtrados = filtrados.filter(r => (r.ciudad || "Sin ciudad") === ciudadSel);
    }

    dibujarEnMapa(filtrados);
    actualizarEstadisticas(filtrados);
  }

  function actualizarEstadisticas(lista) {
    statTotal.textContent = lista.length;

    let cBaja = 0, cMedia = 0, cAlta = 0;
    lista.forEach(r => {
      if (!r.gravedad) return;
      const g = r.gravedad.toLowerCase();
      if (g.startsWith("bajo"))  cBaja++;
      else if (g.startsWith("medio")) cMedia++;
      else if (g.startsWith("alto"))  cAlta++;
    });

    statBaja.textContent  = cBaja;
    statMedia.textContent = cMedia;
    statAlta.textContent  = cAlta;
  }

  function dibujarEnMapa(lista) {
    capaReportes.clearLayers();

    const bounds = L.latLngBounds();

    lista.forEach(r => {
      // 1) Ruta GeoJSON (puede venir como texto o como objeto)
      if (r.rutaGeoJSON) {
        let ruta = null;
        try {
          if (typeof r.rutaGeoJSON === "string") {
            ruta = JSON.parse(r.rutaGeoJSON);
          } else {
            ruta = r.rutaGeoJSON;
          }
        } catch (e) {
          console.error("Ruta inválida para reporte", r, e);
          ruta = null;
        }

        if (ruta) {
          const capaRuta = L.geoJSON(ruta, {
            style: { color: "#007bff", weight: 4 }
          }).addTo(capaReportes);

          try {
            capaRuta.getLayers().forEach(l => {
              if (l.getLatLngs) {
                const pts = l.getLatLngs().flat(Infinity);
                pts.forEach(p => bounds.extend(p));
              }
            });
          } catch (e) {
            // si falla, no hacemos nada especial
          }
        }
      }

      // 2) Punto del problema
      if (typeof r.latProblema === "number" &&
          typeof r.lngProblema === "number") {

        const color = obtenerColorGravedad(r.gravedad);
        const marker = L.circleMarker(
          [r.latProblema, r.lngProblema],
          {
            radius: 7,
            color: color,
            fillColor: color,
            fillOpacity: 0.9
          }
        ).addTo(capaReportes);

        bounds.extend([r.latProblema, r.lngProblema]);

        // Popup
        let html = "";
        html += `<div class="popup-title">${r.problema || "Problema reportado"}</div>`;
        html += `<div class="popup-row"><span>Gravedad:</span> ${r.gravedad || "-"}</div>`;
        html += `<div class="popup-row"><span>Presencia ciclovía:</span> ${r.presencia || "-"}</div>`;
        html += `<div class="popup-row"><span>Ciudad:</span> ${r.ciudad || "-"}</div>`;
        html += `<div class="popup-row"><span>Región:</span> ${r.region || "-"}</div>`;
        if (r.comentario) {
          html += `<div class="popup-row"><span>Comentario:</span> ${r.comentario}</div>`;
        }
        if (r.linkFoto) {
          html += `<div class="popup-row"><span>Foto:</span> <a href="${r.linkFoto}" target="_blank" rel="noopener">Ver imagen</a></div>`;
        }

        marker.bindPopup(html);
      }
    });

    if (bounds.isValid()) {
      map.fitBounds(bounds, { padding: [20, 20] });
    } else {
      map.setView([-35, -70], 5);
    }
  }

  // =========================
  //  CARGA INICIAL
  // =========================
  db.collection("reportes")
    .where("estado", "==", "aprobado")
    .onSnapshot((snap) => {
      todosReportes = [];
      snap.forEach(doc => {
        const data = doc.data();
        // Nos aseguramos de que lat/lng sean números
        if (typeof data.latProblema === "string")
          data.latProblema = parseFloat(data.latProblema);
        if (typeof data.lngProblema === "string")
          data.lngProblema = parseFloat(data.lngProblema);

        todosReportes.push(data);
      });

      poblarFiltros();
      aplicarFiltros();
    }, (err) => {
      console.error("Error leyendo reportes:", err);
      alert("No se pudieron cargar los reportes desde Firebase.");
    });

  // =========================
  //  EVENTOS DE FILTRO
  // =========================
  selectRegion.addEventListener("change", () => {
    actualizarCiudades();
    aplicarFiltros();
  });

  selectCiudad.addEventListener("change", () => {
    aplicarFiltros();
  });
</script>
</body>
</html>


