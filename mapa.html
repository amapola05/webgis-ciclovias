<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa WebGIS – Ciclovías</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
  }
  header {
    background: #26689c;
    color: white;
    padding: 0.5rem 1rem;
    font-size: 1rem;
  }
  header small {
    display: block;
    font-size: 0.75rem;
    opacity: 0.9;
  }
#map {
  width: 30%;
  height: 600px; /* ← antes era 100vh */
  border: 3px solid #ccc;
  border-radius: 8px;
  margin-top: 10px;
}

  }
  .leyenda {
    position: absolute;
    bottom: 12px;
    left: 12px;
    z-index: 1000;
    background: white;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    font-size: 0.8rem;
  }
  .leyenda h3 {
    margin: 0 0 0.25rem 0;
    font-size: 0.9rem;
  }
  .leyenda .item {
    display: flex;
    align-items: center;
    margin-bottom: 0.15rem;
  }
  .leyenda .color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
  }
  .leyenda .linea {
    width: 14px;
    height: 3px;
    border-radius: 2px;
    margin-right: 6px;
  }
</style>
</head>
<body>

<header>
  Mapa de reportes validados de ciclovías
  <small>Se muestran solo los reportes <b>aprobados</b> por el administrador.</small>
</header>

<div id="map"></div>

<div class="leyenda">
  <h3>Leyenda</h3>
  <div class="item">
    <span class="color" style="background: green;"></span> Problema gravedad baja
  </div>
  <div class="item">
    <span class="color" style="background: orange;"></span> Problema gravedad media
  </div>
  <div class="item">
    <span class="color" style="background: red;"></span> Problema gravedad alta
  </div>
  <div class="item">
    <span class="linea" style="background:#0077ff;"></span> Ruta declarada por la persona
  </div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// =======================
//  CONFIG FIREBASE
// =======================
const firebaseConfig = {
  apiKey: "AIzaSyBQxsnjOfPRs7dq7YPpEScStSuQshW9YgU8",
  authDomain: "ciclovias-3d361.firebaseapp.com",
  projectId: "ciclovias-3d361",
  storageBucket: "ciclovias-3d361.appspot.com",
  messagingSenderId: "94373830982",
  appId: "1:94373830982:web:afbf251bfc78b9c7744547"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// =======================
//  MAPA
// =======================
const map = L.map("map").setView([-37.47, -72.35], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

const colores = {
  "Bajo": "green",
  "Medio": "orange",
  "Alto": "red"
};

const grupoElementos = L.featureGroup().addTo(map);

// =======================
// Cargar reportes aprobados
// =======================
db.collection("reportes")
  .where("estado", "==", "aprobado")
  .onSnapshot((query) => {
    grupoElementos.clearLayers();

    query.forEach((doc) => {
      const data = doc.data();

      // Punto
      const punto = L.circleMarker([data.latProblema, data.lngProblema], {
        radius: 8,
        color: colores[data.gravedad] || "blue",
        fillColor: colores[data.gravedad] || "blue",
        fillOpacity: 0.9
      });

      const foto = data.fotoURL
        ? `<a href="${data.fotoURL}" target="_blank">Ver foto</a>`
        : "No enviada";

      punto.bindPopup(`
        <b>Problema:</b> ${data.problema}<br>
        <b>Gravedad:</b> ${data.gravedad}<br>
        <b>Comentario:</b> ${data.comentario || "Sin comentario"}<br>
        <b>Coordenadas:</b> ${data.latProblema.toFixed(4)}, ${data.lngProblema.toFixed(4)}<br>
        <b>Foto:</b> ${foto}
      `);

      punto.addTo(grupoElementos);

      // Ruta
      try {
        const rutaJSON = JSON.parse(data.rutaGeoJSON);
        const ruta = L.geoJSON(rutaJSON, {
          style: { color: "#0077ff", weight: 3 }
        });
        ruta.addTo(grupoElementos);
      } catch (e) {
        console.warn("Ruta inválida en reporte", doc.id);
      }
    });

    if (grupoElementos.getLayers().length > 0) {
      map.fitBounds(grupoElementos.getBounds(), { padding: [30, 30] });
    }
  });
</script>
</body>
</html>
