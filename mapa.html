<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de reportes validados de ciclovías</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js para el gráfico -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f6fa;
    }

    h1 {
      margin: 0;
      padding: 0.8rem 1rem;
      background: #26689c;
      color: white;
      font-size: 1.2rem;
    }

    .subtitulo {
      margin: 0;
      padding: 0 1rem 0.8rem 1rem;
      font-size: 0.85rem;
      color: #444;
      background: #26689c;
      color: #e8f3ff;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
    }

    #map {
      width: 100%;
      height: 520px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .panel-derecha {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      font-size: 0.9rem;
    }

    .panel-derecha h2 {
      margin-top: 0;
      font-size: 1rem;
    }

    select {
      width: 100%;
      padding: 0.35rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-bottom: 0.7rem;
      box-sizing: border-box;
    }

    .badge {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      color: white;
      margin-left: 0.2rem;
    }
    .baja  { background: #3cb44b; }  /* verde */
    .media { background: #f0ad4e; }  /* amarillo */
    .alta  { background: #d9534f; }  /* rojo   */

    .leyenda {
      margin-top: 0.8rem;
      padding: 0.6rem;
      background: white;
      border-radius: 6px;
      font-size: 0.8rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .leyenda h3 {
      margin: 0 0 0.3rem 0;
      font-size: 0.9rem;
    }
    .leyenda-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      margin-bottom: 0.2rem;
    }
    .leyenda-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .c-verde    { background: #3cb44b; }
    .c-amarillo { background: #f0ad4e; }
    .c-rojo     { background: #d9534f; }
    .c-azul     { background: #007bff; }

    /* Área del gráfico */
#graficoProblemas {
  width: 100%;
  max-width: 100%;
  height: 200px;      /* <<< ALTO FIJO DEL GRÁFICO */
  max-height: 220px;  /* por si acaso */
  margin-top: 0.8rem;
}


    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      #map {
        height: 420px;
      }
    }
  </style>
</head>
<body>
  <h1>Mapa de reportes validados de ciclovías</h1>
  <p class="subtitulo">
    Se muestran solo los reportes <strong>aprobados</strong> por el administrador.
  </p>

  <main>
    <div class="layout">
      <div>
        <div id="map"></div>

        <div class="leyenda">
          <h3>Leyenda</h3>
          <div class="leyenda-item">
            <span class="leyenda-color c-verde"></span>
            <span>Problema gravedad baja</span>
          </div>
          <div class="leyenda-item">
            <span class="leyenda-color c-amarillo"></span>
            <span>Problema gravedad media</span>
          </div>
          <div class="leyenda-item">
            <span class="leyenda-color c-rojo"></span>
            <span>Problema gravedad alta</span>
          </div>
          <div class="leyenda-item">
            <span class="leyenda-color c-azul"></span>
            <span>Ruta declarada por la persona</span>
          </div>
        </div>
      </div>

      <aside class="panel-derecha">
        <h2>Filtros y resumen</h2>

        <label for="filtroRegion">Región</label>
        <select id="filtroRegion">
          <option value="todas">Todas las regiones</option>
        </select>

        <label for="filtroCiudad">Ciudad / comuna</label>
        <select id="filtroCiudad">
          <option value="todas">Todas las ciudades</option>
        </select>

        <p>
          <strong>Reportes mostrados:</strong>
          <span id="totalReportes">0</span>
        </p>
        <p>
          Gravedad baja:
          <span id="countBaja">0</span>
          <span class="badge baja">Baja</span>
        </p>
        <p>
          Gravedad media:
          <span id="countMedia">0</span>
          <span class="badge media">Media</span>
        </p>
        <p>
          Gravedad alta:
          <span id="countAlta">0</span>
          <span class="badge alta">Alta</span>
        </p>

        <p style="margin-top:0.8rem;">
          <strong>Problema más frecuente:</strong>
          <span id="problemaFrecuente">Sin datos</span>
        </p>

        <!-- Gráfico de distribución de problemas -->
        <div style="margin-top:1rem;">
          <strong>Distribución de problemas reportados</strong>
          <canvas id="graficoProblemas"></canvas>
        </div>

        <p style="font-size:0.8rem; color:#555; margin-top:0.8rem;">
          Los filtros aplican solo a los reportes validados. Puedes usarlos para revisar
          situaciones particulares en una región o ciudad específica.
        </p>
      </aside>
    </div>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // =========================
    //  CONFIGURACIÓN FIREBASE
    //  (mismo proyecto que index/admin)
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyBQxsnjOfPRs7dq7YPpEScStSuQshW9YgU8",
      authDomain: "ciclovias-3d361.firebaseapp.com",
      projectId: "ciclovias-3d361",
      storageBucket: "ciclovias-3d361.appspot.com",
      messagingSenderId: "94373830982",
      appId: "1:94373830982:web:afbf251bfc78b9c7744547"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =========================
    //  MAPA LEAFLET
    // =========================
    const map = L.map("map").setView([-33.45, -70.66], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const capaRutas   = L.layerGroup().addTo(map);
    const capaPuntos  = L.layerGroup().addTo(map);

    function colorPorGravedad(gravedad) {
      if (gravedad === "Alto" || gravedad === "alta" || gravedad === "Alta")   return "#d9534f";
      if (gravedad === "Medio" || gravedad === "media" || gravedad === "Media") return "#f0ad4e";
      return "#3cb44b"; // Bajo
    }

    // =========================
    //  MANEJO DE DATOS
    // =========================
    let todosReportes = [];

    const filtroRegion  = document.getElementById("filtroRegion");
    const filtroCiudad  = document.getElementById("filtroCiudad");
    const totalSpan     = document.getElementById("totalReportes");
    const bajaSpan      = document.getElementById("countBaja");
    const mediaSpan     = document.getElementById("countMedia");
    const altaSpan      = document.getElementById("countAlta");
    const problemaSpan  = document.getElementById("problemaFrecuente");

    // Referencia al canvas del gráfico
    const ctxGrafico = document.getElementById("graficoProblemas").getContext("2d");
    let problemaChart = null;

    filtroRegion.addEventListener("change", aplicarFiltros);
    filtroCiudad.addEventListener("change", aplicarFiltros);

    // Escuchar cambios solo en reportes aprobados
    db.collection("reportes")
      .where("estado", "==", "aprobado")
      .onSnapshot((snapshot) => {
        todosReportes = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          data.id = doc.id;
          todosReportes.push(data);
        });

        actualizarOpcionesFiltros();
        aplicarFiltros();
      });

    function actualizarOpcionesFiltros() {
      const regiones = new Set();
      const ciudades = new Set();

      todosReportes.forEach((rep) => {
        if (rep.region) regiones.add(rep.region);
        if (rep.ciudad) ciudades.add(rep.ciudad);
      });

      // Región
      filtroRegion.innerHTML = '<option value="todas">Todas las regiones</option>';
      Array.from(regiones).sort().forEach((reg) => {
        const opt = document.createElement("option");
        opt.value = reg;
        opt.textContent = reg;
        filtroRegion.appendChild(opt);
      });

      // Ciudad
      filtroCiudad.innerHTML = '<option value="todas">Todas las ciudades</option>';
      Array.from(ciudades).sort().forEach((ciu) => {
        const opt = document.createElement("option");
        opt.value = ciu;
        opt.textContent = ciu;
        filtroCiudad.appendChild(opt);
      });
    }

    // Actualiza o crea el gráfico de barras según el conteo de problemas
    function actualizarGraficoProblemas(conteoProblemas) {
      const etiquetas = Object.keys(conteoProblemas);
      const datos = Object.values(conteoProblemas);

      // Si no hay datos, mostramos un gráfico vacío
      if (etiquetas.length === 0) {
        if (problemaChart) {
          problemaChart.data.labels = [];
          problemaChart.data.datasets[0].data = [];
          problemaChart.update();
        }
        return;
      }

      if (!problemaChart) {
        problemaChart = new Chart(ctxGrafico, {
          type: "bar",
          data: {
            labels: etiquetas,
            datasets: [{
              label: "Número de reportes",
              data: datos,
              backgroundColor: "#26689c"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => ` ${context.parsed.y} reporte(s)`
                }
              }
            }
          }
        });
      } else {
        problemaChart.data.labels = etiquetas;
        problemaChart.data.datasets[0].data = datos;
        problemaChart.update();
      }
    }

    function aplicarFiltros() {
      const regSel  = filtroRegion.value;
      const ciuSel  = filtroCiudad.value;

      capaRutas.clearLayers();
      capaPuntos.clearLayers();

      let total = 0;
      let baja = 0, media = 0, alta = 0;

      const conteoProblemas = {};

      todosReportes.forEach((rep) => {
        if (regSel !== "todas" && rep.region !== regSel) return;
        if (ciuSel !== "todas" && rep.ciudad !== ciuSel) return;

        total++;

        // Conteo por gravedad
        if (rep.gravedad === "Alto" || rep.gravedad === "alta" || rep.gravedad === "Alta") {
          alta++;
        } else if (rep.gravedad === "Medio" || rep.gravedad === "media" || rep.gravedad === "Media") {
          media++;
        } else {
          baja++;
        }

        // Conteo por problema
        if (rep.problema) {
          conteoProblemas[rep.problema] = (conteoProblemas[rep.problema] || 0) + 1;
        }

        // Dibujar ruta (si viene)
        if (rep.rutaGeoJSON) {
          try {
            const geo = JSON.parse(rep.rutaGeoJSON);
            const coords = geo.geometry?.coordinates || geo.coordinates;
            if (coords) {
              const latlngs = coords.map((c) => [c[1], c[0]]);
              L.polyline(latlngs, {
                color: "#007bff",
                weight: 3,
                opacity: 0.7
              }).addTo(capaRutas);
            }
          } catch (e) {
            console.warn("Error al leer rutaGeoJSON:", e);
          }
        }

        // Dibujar punto del problema
        if (rep.latProblema && rep.lngProblema) {
          const color = colorPorGravedad(rep.gravedad);
          const marker = L.circleMarker([rep.latProblema, rep.lngProblema], {
            radius: 7,
            color,
            fillColor: color,
            fillOpacity: 0.9
          }).addTo(capaPuntos);

          let popupHtml = `<strong>${rep.problema || "Problema"}</strong><br>`;
          popupHtml += `Gravedad: ${rep.gravedad || "-"}<br>`;
          popupHtml += `Presencia: ${rep.presencia || "-"}<br>`;
          popupHtml += `Región: ${rep.region || "-"}<br>`;
          popupHtml += `Ciudad: ${rep.ciudad || "-"}<br>`;
          if (rep.comentario) {
            popupHtml += `<em>${rep.comentario}</em><br>`;
          }
          if (rep.linkFoto) {
            popupHtml += `<a href="${rep.linkFoto}" target="_blank">Ver foto</a>`;
          }

          marker.bindPopup(popupHtml);
        }
      });

      // Actualizar contadores
      totalSpan.textContent = total;
      bajaSpan.textContent = baja;
      mediaSpan.textContent = media;
      altaSpan.textContent = alta;

      // Calcular problema más frecuente
      if (total === 0 || Object.keys(conteoProblemas).length === 0) {
        problemaSpan.textContent = "Sin datos";
      } else {
        let max = 0;
        let problemaMax = "";
        for (const [prob, count] of Object.entries(conteoProblemas)) {
          if (count > max) {
            max = count;
            problemaMax = prob;
          }
        }
        problemaSpan.textContent = `${problemaMax} (${max} reporte${max > 1 ? "s" : ""})`;
      }

      // Actualizar gráfico con el mismo conteo de problemas
      actualizarGraficoProblemas(conteoProblemas);
    }
  </script>
</body>
</html>
